#!/bin/bash

# This script publishes what is created from the 'build' script to S3.
# WARNING: Please do not run this script directly, use the arm tool.

set -e
cd "$(dirname "$0")"/..

BUILD_DIR="$(pwd)/build"
ARTIFACT_NAME="install-${GIT_HASH}.sh"
LOCAL_ARTIFACT_PATH=${BUILD_DIR}/${ARTIFACT_NAME}

ls "${LOCAL_ARTIFACT_PATH}" || { 
    echo "Could not find ${LOCAL_ARTIFACT_PATH}. Please run 'build'."  
    exit 1 
}

BUCKET="s3://armory-web"
PREFIX="install/"

# Put releases in a different location than branches
PREFIX="install/developement/${BRANCH_NAME}"
if [[ "${BRANCH_NAME}" == "master" ]]; then
  PREFIX="install/release"
fi

S3_DEST="${BUCKET}/${PREFIX}/${ARTIFACT_NAME}"
echo "Uploading to get.armory.io/"
aws s3 cp ${LOCAL_ARTIFACT_PATH} ${S3_DEST}
echo "You can find your artifact at ${S3_DEST}"
