#!/bin/bash
IMAGE_ID=ami-b7963cd7

result=$(aws sts assume-role \
        --role-arn arn:aws:iam::916699154726:role/StagingAdmin \
        --role-session-name "StagingAdminSession"  \
        --output=text --query 'Credentials.[SecretAccessKey, AccessKeyId, SessionToken]')

mkdir -p ./build

AWS_SECRET_ACCESS_KEY=`echo $result | awk '{print $1}'`
AWS_ACCESS_KEY_ID=`echo $result | awk '{print $2}'`
AWS_SESSION_TOKEN=`echo $result | awk '{print $3}'`

echo "running integration with docker: ${DOCKER_IMAGE}"
$DOCKER_RUN \
  ${DOCKER_ENV} \
  --entrypoint=/bin/bash \
  -e "IMAGE_ID=${IMAGE_ID}" \
  -e "AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}" \
  -e "AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" \
  -e "AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}" \
  -v ${BASE_DIR}/src/python/armory:/home/armory/python/armory \
  -v ${BASE_DIR}/src/terraform/:/home/terraform/ \
  "${DOCKER_IMAGE}"
